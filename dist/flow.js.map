{"version":3,"sources":["main.js"],"names":[],"mappings":"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","file":"flow.js","sourcesContent":["(() =>{\n  const UNSET =   {}\n      , PRIVATE = {}\n      , FLOW =    {}\n      , DEFAULT =     'DEFAULT'\n      , UPSTREAM =    'UPSTREAM'\n      , DOWNSTREAM =  'DOWNSTREAM'\n\n  var matcher = (flow,name) => (flow.name()==name)\n  var id = 0\n  var create = (name, ...data) =>{\n    var state = {\n          children :   []\n        , listenerMap: {}\n        , matcher:     matcher\n        , parent:      null\n        , name:        null\n        , data:        []\n        , cancelled:   false\n        , direction:   DEFAULT\n        , id :         id++\n      }\n      , flow = {}\n\n    flow.create = (name, ...data) => {\n      var instance = create(name, ...data)\n      instance.direction(flow.direction())\n      instance.parent(flow)\n      return instance\n    }\n\n    flow.parent = (parent=UNSET) => {\n      if (parent===UNSET) return state.parent;\n      \n      if (parent && !isFlow(parent)){\n        throw new Error('Invalid Argument. flow.parent(arg) accepts a flow object or null')\n        return\n      }\n      \n      detach(flow)\n      attach(flow, parent)\n      return flow\n    }\n\n    flow.parents = (...args) => {\n      if (args.length) {\n        throw new Error('Invalid Argument. Please use child.parent(parent) to re-parent flow objects')\n      }\n      var parentMap = {}\n      var parents = []\n      var p = flow.parent()\n      while (p && !parentMap[p.data(PRIVATE).id]){\n        parents.push(p)\n        parentMap[p.data(PRIVATE).id]=true\n        p = p.parent()\n      }\n      return parents\n    }\n    \n    flow.name = (name=UNSET) => {\n      if (name===UNSET) return state.name\n      return state.name = name, flow\n    }\n    \n    flow.matcher = (matcher=UNSET) => {\n      if (matcher===UNSET) return state.matcher\n      return state.matcher = matcher, flow\n    }\n\n    flow.direction = (direction=UNSET) => {\n      if (direction===UNSET) return state.direction\n      return state.direction = direction, flow\n    }\n    flow.direction.DEFAULT = DEFAULT\n    flow.direction.UPSTREAM = UPSTREAM\n    flow.direction.DOWNSTREAM = DOWNSTREAM\n\n    flow.children = (...args) => {\n      if (args.length) {\n        throw new Error('Invalid Argument. Please use child.parent(parent) to re-parent flow objects')\n      }\n      return state.children.concat()\n    }\n\n    flow.data = (...data) => {\n      if (!data.length) {\n        return (state.data.length<=1)\n          ? state.data[0]\n          : state.data\n      }\n      if (data[0]==PRIVATE) return state \n      if (data[0]==FLOW) return FLOW\n      return state.data = data, flow\n    }\n\n    flow.emit = (name=UNSET, ...data) => {\n      var instance = (name==UNSET)\n        ? flow\n        : flow.create(name,...data)\n      emit(instance)\n      return flow\n    }\n\n    /**\n     *  .on('foo', handler1, handler2, :phase)\n     */ \n    flow.on = (name=UNSET, ...listeners) => {\n      var phaseMarker = listeners.concat().pop()\n      var phase = DEFAULT\n      if (phaseMarker===DEFAULT\n        || phaseMarker===UPSTREAM\n        || phaseMarker===DOWNSTREAM ){\n        phase = phaseMarker\n        listeners.pop()\n      }\n\n      if (name===UNSET) {\n        throw new Error('Invalid Argument. Please use .on(\"name\", ...listener) to add listeners')\n        return;\n      }\n      if (!listeners.length){\n        return state.listenerMap[name]\n          ? state.listenerMap[name][phase].concat()\n          : []\n      }\n      \n      if (!state.listenerMap[name]){\n        var l = state.listenerMap[name] = {}\n        l[DEFAULT]=  []\n        l[UPSTREAM]= []\n        l[DOWNSTREAM]=   []\n      }\n      state.listenerMap[name][phase] = listeners\n        .filter(l=>l && l.call)\n\n      return flow\n    }\n\n    flow.cancel = (cancelled=true) => {\n      return state.cancelled = cancelled, flow\n    }\n\n    flow.cancelled = (cancelled=UNSET) => {\n      if (cancelled===UNSET) return state.cancelled\n      return flow.cancel(cancelled)\n    }\n\n    flow.name(name)\n    flow.data(...data)\n    return flow\n\n  }\n\n  /**\n   *  Utils\n   */\n  var detach = (flow) => {\n    var parent = flow.parent()\n    if (!isFlow(parent)) return;\n    \n    var state = parent.data(PRIVATE)\n    state.children = \n      state.children\n        .filter(f=>f!=flow)\n  }\n  \n  var attach = (flow, parent) => {\n    \n    isFlow(parent) \n      && parent.data(PRIVATE)\n          .children.push(flow)\n    \n    flow.data(PRIVATE)\n      .parent = parent\n  }\n\n  var isFlow = (flow) => (\n    flow && flow.data(FLOW)==FLOW)\n\n  var emit = (flow) => {\n    var processed = {}\n    flow.recipients = []\n    var deliver = direction => p => {\n      var id = p.data(PRIVATE).id\n      //console.log('checking', p.name(), id)\n      if (direction===DEFAULT && processed[id]) return;\n      var dispatched = dispatch(flow, direction, p)\n      if (dispatched) flow.recipients.push(p)\n      processed[id] = true\n      return !flow.cancelled()\n    }\n\n    var parents = flow.parents()\n    //console.log('parents', parents.map(p=>p.name()))\n    // 1. bubble up - only if direction is DEFAULT or upstream\n    //console.log('flow.direction()', flow.direction())\n    if (flow.direction()==DEFAULT\n      || flow.direction()==UPSTREAM) {\n      parents.every(deliver(DEFAULT))\n      parents.every(deliver(UPSTREAM))\n    }\n\n    // 2. flow down - only if direction is DEFAULT or downstream\n    if (flow.cancelled()) return;\n    // create breadth first list\n    if (flow.direction()==DEFAULT\n      || flow.direction()==DOWNSTREAM) {\n\n      var root = flow.direction()==DOWNSTREAM\n        ? flow.parent()\n        : parents.pop()\n      var recipients = flatten([root])\n      //console.log('flattened:', recipients.map(p=>p.name()))\n      recipients.every(node=>{\n        deliver(DEFAULT)(node)\n        deliver(DOWNSTREAM)(node)\n        return !flow.cancelled()\n      })\n    }\n  }\n\n  var flatten = node => {\n    var nodes = [node]\n    //console.log('nodes', nodes)\n    for (var i=0;i<nodes.length;i++) {\n      var children = nodes[i]\n      //console.log('children', children)\n      children.forEach(f=>{\n        //console.log('f',f)\n        nodes = nodes.concat([f.children()])\n      })\n    }\n    //console.log('nodes final:', nodes)\n    return [].concat.apply([],nodes)\n  }\n\n  var dispatch = (flow, phase, recipient) => {\n    var state = recipient.data(PRIVATE)\n    var delivered = false\n    //console.log('dispatching on', recipient.name(),state.listenerMap)\n    Object.keys(state.listenerMap)\n      .every(key=>{\n        //console.log('matching', flow.name(), '<->', key, ':', state.matcher(flow, key))\n        if (!state.matcher(flow, key)) return false;\n        var l = state.listenerMap[key]\n        var listeners = l[phase]\n        //console.log('listeners', listeners)\n        return listeners.every(f=>{\n          \n          if (flow.cancelled()) return false\n\n          delivered = true\n          //console.log('ok, dispatching', flow.name(),'to', recipient.name() ,'with', flow.data())\n          return f.apply(flow, flow.data(PRIVATE).data), true\n        })\n\n      })\n    return delivered\n  }\n\n\n\n\n\n  module.exports = create('flow')\n\n})()"],"sourceRoot":"/source/"}